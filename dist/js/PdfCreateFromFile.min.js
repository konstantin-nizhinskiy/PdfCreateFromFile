/*
name: pdf-create-from-file
version: 1.1.1
author: Konstantin Nizhinskiy
date: 2020-02-06 13:02:35 

*/
!function(e,t){if("function"==typeof define&&define.amd)define(["pdfMake","JSZip"],t);else if("object"==typeof module&&module.exports)module.exports=t(require("pdfMake"),require("JSZip"));else{if(!e.pdfMake)throw"not fount module pdfMake https://github.com/bpampuch/pdfmake";if(!e.JSZip)throw"not fount module JSZip https://github.com/Stuk/jszip";e.PdfCreateFromFile=t(e.pdfMake,e.JSZip)}}(this,function(e,c){function t(e){if("setLocales"==(e=e||{}))return function(e,t){v.locales[e]=t};if(this._options={wrapper:e.wrapper||document.body,locale:e.locale||"en",maxCountFile:e.maxCountFile||0,listTypeFile:e.listTypeFile||[],typeOpen:e.typeOpen||"download",documentName:e.documentName||"Document",callback:e.callback,locales:e.locales||!1,urlPdfMerge:e.urlPdfMerge||!1,storageId:e.storageId||+new Date},e.locales)for(var t in e.locales)v.locales[t]=e.locales[t];if(m[this.getOption("storageId")]||(m[this.getOption("storageId")]=[]),a.indexOf(this.getOption("typeOpen"))<0)throw"Not fount typeOpen ["+this.getOption("typeOpen")+"]";if(-1<n.indexOf(this.getOption("typeOpen"))&&"function"!=typeof this.getOption("callback"))throw"Set function callback in param callback"}function l(e,t){var a=t.className;-1==a.indexOf(e)&&(""!=a&&(e=" "+e),t.className=a+e)}function g(o,i){var r,n=+new Date,l=document.createElement("div");return r=function(){for(var e=N({id:n,storageId:o.storageId,locales:o.locales}),t=e.getElementsByClassName("btn-delete"),a=0;a<t.length;a++)t[a].onclick=function(e){var a=[],n=e.target.dataset.id;m[o.storageId].forEach(function(e,t){n!=t&&a.push(e)}),m[o.storageId]=a,l.children.length&&l.children[0].remove(),m[o.storageId].forEach(function(e){e.isSupport=s(e.typeName,i)}),u(i),l.appendChild(r()),o.changeFile()};return e},l.appendChild(r()),l}function h(a){var e=+new Date,t=C({id:e,locales:a.locales}),n=this,o=t.getElementsByClassName("drop-zone")[0],i=t.getElementsByClassName("file-load")[0],r=t.getElementsByClassName("text-error")[0];return i.addEventListener("change",function(e){r.innerText="",n.addFile(e.target.files[0],{success:a.success,error:function(e){r.innerText=e}})}),o.ondragover=function(){return r.innerText="",l("hover",o),!1},o.ondragleave=function(){return r.innerText="",w("hover",o),!1},o.ondrop=function(e){e.preventDefault(),r.innerText="",w("hover",o),l("drop",o);var t=e.dataTransfer.files[0];n.addFile(t,{success:a.success,error:function(e){r.innerText=e}})},t}function b(e){var t={};if(v.locales[e])for(var a in v.locales[e])t[a]=v.locales[e][a];else for(var a in v.localesDefault)t[a]=v.localesDefault[a];if(this.getOption("locales"))for(var a in this.getOption("locales"))t[a]=this.getOption("locales")[a];return t}var a=["download","open","print","getBase64","getBlob","getDataUrl","onlyContentFile"],d=["BMP","JPEG","JPG","JPE","JP2","PNG","IMAGE"],p=["TXT","LOG","JS","TEX","TEXT","XML","JSON"],f=["HTML"],n=["getBase64","getBlob","getDataUrl"],m=[],v={localesDefault:{errorArrayLoadFile:"Please delete all not support file",errorTypeFileNotSupport:"This type file not support",btnNameClose:"Close",btnNameAddFile:"Add file",btnNameDelete:"Delete",title:"Create PDF file",btnNameCreate:"Create PDF",textFileSize:"File size",textFileName:"File name",textDrop:"Drag a file here",textOr:"or"},locales:{}},s=function(e,t,a){if(-1<d.indexOf(e.toUpperCase()))return!0;if(-1<p.indexOf(e.toUpperCase()))return!0;if(-1<f.indexOf(e.toUpperCase()))return!0;if("PDF"==e.toUpperCase()){if(m[t.getOption("storageId")].length==a)return!0;if(t.getOption("urlPdfMerge"))return!0}return!1},u=function(t){m[t.getOption("storageId")].forEach(function(e){e.isSupport=s(e.typeName,t,1)})};function y(e,t,a,n){var o=[],i=t.childNodes;if(0!=i.length)for(var r=0;r<i.length;r++)a=k(o,i[r],a,n);if(0!=o.length)for(r=0;r<o.length;r++)e.push(o[r]);return a}function O(o,e){e.forEach(function(e){var t=e.trim().toLowerCase().split(":"),a=t[0],n=t[1];if(2==t.length)switch(a){case"padding-left":o.margin=[parseInt(n),0,0,0];break;case"font-size":o.fontSize=parseInt(n);break;case"text-align":switch(n){case"right":case"center":case"justify":o.alignment=n}break;case"font-weight":switch(n){case"bold":o.bold=!0}break;case"text-decoration":switch(n){case"underline":o.decoration="underline";break;case"line-through":o.decoration="lineThrough"}break;case"font-style":switch(n){case"italic":o.italics=!0}break;case"color":o.color=n;break;case"background-color":o.background=n}})}function k(e,t,a,n){if(n=(n=n||[]).concat({b:["font-weight:bold"],strong:["font-weight:bold"],u:["text-decoration:underline"],em:["font-style:italic"],i:["font-style:italic"],h1:["font-size:16","font-weight:bold"],h2:["font-size:12","font-weight:bold"],h3:["font-size:10","font-weight:bold"],h4:["font-size:10","font-style:italic"],h5:["font-size:10"],h6:["font-size:10"],a:["color:blue","text-decoration:underline"],del:["color:red","text-decoration:line-through"],ins:["color:green","text-decoration:underline"]}[t.nodeName.toLowerCase()]||[]),t.getAttribute){var o=t.getAttribute("style");if(o)for(var i=o.split(";"),r=0;r<i.length;r++)n.push(i[r])}switch(t.nodeName.toLowerCase()){case"#text":var l={text:t.textContent.replace(/\n/g,"")};n&&O(l,n),a.text.push(l);break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":a.marginTop=5,a.marginBottom=5,y(e,t,a,n);break;case"b":case"strong":case"u":case"em":case"i":case"ins":case"del":case"span":y(e,t,a,n);break;case"br":(a=x()).text=["\n"],e.push(a);break;case"table":l={table:{widths:[],body:[]}};var s=t.getAttribute("border"),c=!1;s&&1==parseInt(s)&&(c=!0),c||(l.layout="noBorders"),y(l.table.body,t,a,n);var d=t.getAttribute("widths");if(d){var p=d.split(",");for(r=0;r<p.length;r++)l.table.widths.push(p[r])}else if(0!=l.table.body.length&&0!=l.table.body[0].length)for(var r=0;r<l.table.body[0].length;r++)l.table.widths.push("*");e.push(l);break;case"tbody":y(e,t,a,n);break;case"tr":var f=[];y(f,t,a,n),e.push(f);break;case"td":a=x(),(h={stack:[]}).stack.push(a);var u=t.getAttribute("rowspan");u&&(h.rowSpan=parseInt(u));var g=t.getAttribute("colspan");g&&(h.colSpan=parseInt(g)),y(h.stack,t,a,n),e.push(h);break;case"div":case"p":var h;a=x(),(h={stack:[]}).stack.push(a),O(h,n),y(h.stack,t,a),e.push(h)}return a}function x(){return{text:[]}}ParseHtml=function(e,t){var a=document.createElement("div");a.innerHTML=e,t=t||[];for(var n=0;n<a.children.length;n++)["div","p","table"].indexOf(a.children[n].nodeName.toLowerCase())<0?t.push(k(t,a.children[n],x(),[])):k(t,a.children[n],x(),[]);return t};var w=function(e,t){var a=t.className,n=new RegExp("\\s?\\b"+e+"\\b","g");a=a.replace(n,""),t.className=a},N=function(i){var r=document.createElement("div");return m[i.storageId].forEach(function(e,t){var a,n=document.createElement("div"),o="";n.className="",!1===e.isSupport&&(n.className=" error-support",o='<div class="text-error">'+i.locales.errorTypeFileNotSupport+"</div>"),a="image"==e.typeName?'<img src="'+e.content+'" alt="" class="img-rounded">':'<div class="img-rounded">'+e.typeName+"</div>",n.className+=" wrapper-img",n.innerHTML=a+'<div class="block-info"><div><div class="label-file">'+i.locales.textFileName+'</div><div class="info-file">'+e.name+'</div></div><div><div class="label-file">'+i.locales.textFileSize+'</div><div class="info-file">'+e.sizeName+"</div></div>"+o+'<div><button type="button" class="btn btn-default btn-delete " data-id="'+t+'" >'+i.locales.btnNameDelete+"</button></div></div>",r.appendChild(n)}),r},C=function(e){var t=document.createElement("div");return t.innerHTML='<div class="drop-zone"><div>'+e.locales.textDrop+"</div><div>"+e.locales.textOr+'</div><div class="text-error"></div><div class="drop-zone-message"><div><input class="file-load" type="file"></div></div></div></div>',t};t.prototype.addFile=function(n,i){var o,r=new FileReader,l=this,e=b.call(this,this.getOption("locale")),t=n.name.split(".").pop();if(0<this.getOption("listTypeFile").length){var a=!1;if(this.getOption("listTypeFile").forEach(function(e){t.toUpperCase()===e.toUpperCase()&&(a=!0)}),0==a)return i.error(e.errorTypeFileNotSupport),!1}if(-1<n.type.indexOf("image")||-1<d.indexOf(t.toUpperCase()))o="image";else if(-1<n.type.indexOf("html")||-1<f.indexOf(t.toUpperCase()))o="html";else if(-1<n.type.indexOf("text")||-1<n.type.indexOf("xml")||-1<n.type.indexOf("json")||-1<p.indexOf(t.toUpperCase()))o="text";else if(-1<n.type.indexOf("pdf"))o="pdf";else{if(!(-1<n.type.indexOf("zip")))return i.error(e.errorTypeFileNotSupport),!1;o="zip",c().loadAsync(n).then(function(e){for(var t in e.files)!function(e){var t,a,n,o;t=e.name.split(".").pop(),a=e,n="base64",o="",-1<d.indexOf(t.toUpperCase())?(o="data:image/"+t.toLowerCase()+";base64,",t="image",n="base64"):-1<p.indexOf(t.toUpperCase())?(t="text",n="string"):-1<f.indexOf(t.toUpperCase())&&(t="html",n="string"),a.async(n).then(function(e){m[l.getOption("storageId")].push({lastModified:+a.date,name:a.name,size:0,sizeName:"ZIP",type:t,typeName:t,content:o+e}),u(l),i.success()})}(e.files[t])})}if("zip"!=o){var s=!1;r.onload=function(e){if(0==s&&-1<e.target.result.indexOf('encoding="windows-1251"'))return s=!0,r.readAsText(n,"windows-1251"),!1;var t,a;m[l.getOption("storageId")].push({lastModified:n.lastModified,name:n.name,size:n.size,sizeName:(t=n.size,a=Math.floor(Math.log(t)/Math.log(1024)),+(t/Math.pow(1024,a)).toFixed(2)+" "+["B","kB","MB","GB","TB"][a]),type:n.type,typeName:o,content:e.target.result}),u(l),i.success()},-1<p.indexOf(o.toUpperCase())||-1<f.indexOf(o.toUpperCase())?r.readAsText(n,"UTF-8"):r.readAsDataURL(n)}};var o={};return t.prototype.on=function(e,t){void 0===o[e]&&(o[e]={callback:[],callbackOnce:[]}),o[e].callback.push(t)},t.prototype.once=function(e,t){void 0===o[e]&&(o[e]={callback:[],callbackOnce:[]}),o[e].callbackOnce.push(t)},t.prototype.off=function(e,t){var a;if("function"==typeof t){if(o[e].callback&&0<o[e].callback.length){a=[];for(var n=0;n<o[e].callback.length;n++)"function"==typeof o[e].callback[n]&&o[e].callback[n]!==t&&a.push(o[e].callback[n]);o[e].callback=a}if(o[e].callbackOnce&&0<o[e].callbackOnce.length){a=[];for(n=0;n<o[e].callbackOnce.length;n++)"function"==typeof o[e].callbackOnce[n]&&o[e].callbackOnce[n]!==t&&a.push(o[e].callbackOnce[n]);o[e].callbackOnce=a}}else delete o[e]},t.prototype.trigger=function(e){if(o[e]){var t=[];for(var a in arguments)0!=a&&t.push(arguments[a]);if(o[e].callback&&0<o[e].callback.length)for(var n=0;n<o[e].callback.length;n++)"function"==typeof o[e].callback[n]&&o[e].callback[n].apply(this,t);if(o[e].callbackOnce&&0<o[e].callbackOnce.length){for(n=0;n<o[e].callbackOnce.length;n++)"function"==typeof o[e].callbackOnce[n]&&o[e].callbackOnce[n].apply(this,t);o[e].callbackOnce=[]}}},t.prototype.getOption=function(e){return this._options[e]},t.prototype.isValid=function(){var t=!0;return m[this.getOption("storageId")].forEach(function(e){!1===e.isSupport&&(t=!1)}),t},t.prototype.openModal=function(e,t){if(e=e||this.getOption("typeOpen"),a.indexOf(e)<0)throw"Not fount typeOpen ["+e+"]";if(-1<n.indexOf(e)&&"function"!=typeof t)throw"Set function callback in param callback";this.getOption("wrapper").appendChild(this.view(e,t))},t.prototype.view=function(o,i){var e,t,a=+new Date,r=this,l=b.call(this,this.getOption("locale")),s=(e={id:a,locales:l,btnNameClose:v.btnNameClose,btnNameAddFile:v.btnNameAddFile,btnNameCreate:v.btnNameCreate,title:v.title},(t=document.createElement("div")).innerHTML='<div class="wrapper-pdf-create"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">'+e.locales.title+'</div><div class="modal-body" style="max-height: 540px" ></div><div class="modal-footer"><button type="button" class="btn btn-default btn-close " data-dismiss="modal">'+e.locales.btnNameClose+'</button><button type="button" class="btn btn-primary btn-add">'+e.locales.btnNameAddFile+'</button><span class="error-footer text-error"></span><button type="button" class="btn btn-success btn-save">'+e.locales.btnNameCreate+"</button></div></div></div></div>",t),n=s.getElementsByClassName("modal-body")[0],c=s.getElementsByClassName("btn-close")[0],d=s.getElementsByClassName("btn-add")[0],p=s.getElementsByClassName("error-footer")[0],f=s.getElementsByClassName("btn-save")[0],u=function(){0==m[r.getOption("storageId")].length?(d.style.display="none",f.style.display="none",n.appendChild(h.call(r,{locales:l,success:function(){d.style.display="block",f.style.display="block",n.innerHTML="",n.appendChild(g({storageId:r.getOption("storageId"),locales:l,changeFile:u}),r),u()}}))):0<r.getOption("maxCountFile")&&(r.getOption("maxCountFile")<=m[r.getOption("storageId")].length?d.style.display="none":d.style.display="block")};return c.onclick=function(e){s.remove(),r.trigger("close")},f.onclick=function(e){if(p.innerText="",!1===r.isValid())return p.innerText=l.errorArrayLoadFile,!1;if("onlyContentFile"==o&&i(m[r.getOption("storageId")]),1==m[r.getOption("storageId")].length&&"PDF"==m[r.getOption("storageId")][0].typeName.toUpperCase()){switch(o){case"getBase64":i(m[r.getOption("storageId")][0].content.substring(m[r.getOption("storageId")][0].content.indexOf("base64,")+7)),s.remove(),r.trigger("close");break;case"getDataUrl":i(m[r.getOption("storageId")][0].content),s.remove(),r.trigger("close");break;default:p.innerText="Work only function callback getBase64 getDataUrl"}return!1}var a={content:[]},n=[];m[r.getOption("storageId")].forEach(function(e,t){"image"==e.typeName&&a.content.push({image:e.content,fit:[525,700]}),"html"==e.typeName&&ParseHtml(e.content,a.content),"text"==e.typeName&&a.content.push({text:e.content,fontSize:8}),"PDF"==e.typeName.toUpperCase()&&n.push(e.content.split(";base64,")[1])});function t(e,t){var a=new XMLHttpRequest;a.open("POST",r.getOption("urlPdfMerge"),!0),a.setRequestHeader("Content-type","application/json; charset=utf-8"),a.onreadystatechange=function(){if(4==a.readyState)if(200!=a.status)r.trigger("error","error:merge_pdf",a.statusText,a.status,a),r.trigger("error:merge_pdf",a.statusText,a.status,a);else{var e=JSON.parse(a.responseText);e.file?t(e.file):(r.trigger("error","error:merge_pdf:res","Error response from urlPdfMerge not return attr file"),r.trigger("error:merge_pdf:res","Error response from urlPdfMerge not return attr file"))}},a.send(JSON.stringify(e))}switch(o){case"download":pdfMake.createPdf(a).download(r.getOption("documentName")+".pdf");break;case"open":pdfMake.createPdf(a).open();break;case"print":pdfMake.createPdf(a).print();break;case"getBase64":r.waitStart(),r.getOption("urlPdfMerge")&&n.length&&n.length==m[r.getOption("storageId")].length?t({files:n,type:"base64"},function(e){i(e),r.waitStop()}):pdfMake.createPdf(a).getBase64(function(e){r.getOption("urlPdfMerge")&&n.length?t({files:n.concat([e]),type:"base64"},function(e){i(e),r.waitStop()}):(i(e),r.waitStop())});break;case"getBlob":r.waitStart(),pdfMake.createPdf(a).getBlob(function(e){i(e),r.waitStop()});break;case"getDataUrl":r.waitStart(),pdfMake.createPdf(a).getDataUrl(function(e){i(e),r.waitStop()})}s.remove(),r.trigger("close")},d.onclick=function(e){d.style.display="none",f.style.display="none",r.trigger("add:file"),n.appendChild(h.call(r,{locales:l,success:function(){d.style.display="block",f.style.display="block",n.innerHTML="",n.appendChild(g({storageId:r.getOption("storageId"),locales:l,changeFile:u},r)),u()}})),n.scrollTop=n.scrollHeight},m[r.getOption("storageId")].length?n.appendChild(g({storageId:r.getOption("storageId"),locales:l,changeFile:u},r)):(d.style.display="none",f.style.display="none",n.appendChild(h.call(r,{locales:l,success:function(){d.style.display="block",f.style.display="block",n.innerHTML="",n.appendChild(g({storageId:r.getOption("storageId"),locales:l,changeFile:u},r)),u()}}))),s},t.prototype.waitStart=function(){var e;this._templateWait&&this._templateWait.remove(),this._templateWait=((e=document.createElement("div")).className="wrapper-pdf-waite",e.innerHTML='<div class="floatingCirclesG"><div class="f_circleG frotateG_01"></div><div class="f_circleG frotateG_02"></div><div class="f_circleG frotateG_03"></div><div class="f_circleG frotateG_04"></div><div class="f_circleG frotateG_05"></div><div class="f_circleG frotateG_06"></div><div class="f_circleG frotateG_07"></div><div class="f_circleG frotateG_08"></div></div>',e),this.getOption("wrapper").appendChild(this._templateWait)},t.prototype.waitStop=function(e,t){this._templateWait&&this._templateWait.remove()},t});