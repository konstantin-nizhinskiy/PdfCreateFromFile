/*
name: pdf-create-from-file
version: 1.0.0
author: Konstantin Nizhinskiy
date: 2017-03-07 11:03:57 

*/
!function(a,b){if("function"==typeof define&&define.amd)define(["pdfMake","JSZip"],b);else if("object"==typeof module&&module.exports)module.exports=b(require("pdfMake"),require("JSZip"));else{if(!a.pdfMake)throw"not fount module pdfMake https://github.com/bpampuch/pdfmake";if(!a.JSZip)throw"not fount module JSZip https://github.com/Stuk/jszip";a.PdfCreateFromFile=b(a.pdfMake,a.JSZip)}}(this,function(a,b){function c(a,b,c,d){var f=[],g=b.childNodes;if(0!=g.length)for(var h=0;h<g.length;h++)c=e(f,g[h],c,d);if(0!=f.length)for(var h=0;h<f.length;h++)a.push(f[h]);return c}function d(a,b){b.forEach(function(b){var c=b.trim().toLowerCase().split(":"),d=c[0],e=c[1];if(2==c.length)switch(d){case"padding-left":a.margin=[parseInt(e),0,0,0];break;case"font-size":a.fontSize=parseInt(e);break;case"text-align":switch(e){case"right":case"center":case"justify":a.alignment=e}break;case"font-weight":switch(e){case"bold":a.bold=!0}break;case"text-decoration":switch(e){case"underline":a.decoration="underline";break;case"line-through":a.decoration="lineThrough"}break;case"font-style":switch(e){case"italic":a.italics=!0}break;case"color":a.color=e;break;case"background-color":a.background=e}})}function e(a,b,e,g){var h={b:["font-weight:bold"],strong:["font-weight:bold"],u:["text-decoration:underline"],em:["font-style:italic"],i:["font-style:italic"],h1:["font-size:16","font-weight:bold"],h2:["font-size:12","font-weight:bold"],h3:["font-size:10","font-weight:bold"],h4:["font-size:10","font-style:italic"],h5:["font-size:10"],h6:["font-size:10"],a:["color:blue","text-decoration:underline"],del:["color:red","text-decoration:line-through"],ins:["color:green","text-decoration:underline"]};if(g||(g=[]),g=g.concat(h[b.nodeName.toLowerCase()]||[]),b.getAttribute){var i=b.getAttribute("style");if(i)for(var j=i.split(";"),k=0;k<j.length;k++)g.push(j[k])}switch(b.nodeName.toLowerCase()){case"#text":var l={text:b.textContent.replace(/\n/g,"")};g&&d(l,g),e.text.push(l);break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":e.marginTop=5,e.marginBottom=5,c(a,b,e,g);break;case"b":case"strong":case"u":case"em":case"i":case"ins":case"del":c(a,b,e,g);break;case"span":c(a,b,e,g);break;case"br":e=f(),e.text=["\n"],a.push(e);break;case"table":var l={table:{widths:[],body:[]}},m=b.getAttribute("border"),n=!1;m&&1==parseInt(m)&&(n=!0),n||(l.layout="noBorders"),c(l.table.body,b,e,g);var o=b.getAttribute("widths");if(o)for(var p=o.split(","),k=0;k<p.length;k++)l.table.widths.push(p[k]);else if(0!=l.table.body.length&&0!=l.table.body[0].length)for(var k=0;k<l.table.body[0].length;k++)l.table.widths.push("*");a.push(l);break;case"tbody":c(a,b,e,g);break;case"tr":var q=[];c(q,b,e,g),a.push(q);break;case"td":e=f();var r={stack:[]};r.stack.push(e);var s=b.getAttribute("rowspan");s&&(r.rowSpan=parseInt(s));var t=b.getAttribute("colspan");t&&(r.colSpan=parseInt(t)),c(r.stack,b,e,g),a.push(r);break;case"div":case"p":e=f();var r={stack:[]};r.stack.push(e),d(r,g),c(r.stack,b,e),a.push(r)}return e}function f(){return{text:[]}}var g=function(a){if(a=a||{},"setLocales"==a)return function(a,b){n.locales[a]=b};if(this._wrapper=a.wrapper||document.body,this._locale=a.locale||"en",this._typeOpen=a.typeOpen||"download",this._documentName=a.documentName||"Document",this._callback=a.callback,this._locales=a.locales||!1,this._storageId=a.storageId||+new Date,a.locales)for(var b in a.locales)n.locales[b]=a.locales[b];if(m[this._storageId]||(m[this._storageId]=[]),h.indexOf(this._typeOpen)<0)throw"Not fount typeOpen ["+this._typeOpen+"]";if(l.indexOf(this._typeOpen)>-1&&"function"!=typeof this._callback)throw"Set function callback in param callback"},h=["download","open","print","getBase64","getBlob","getDataUrl"],i=["BMP","JPEG","JPG","JPE","JP2","PNG","IMAGE"],j=["TXT","LOG","JS","TEX","TEXT"],k=["HTML"],l=["getBase64","getBlob","getDataUrl"],m=[],n={localesDefault:{errorArrayLoadFile:"Please delete all not support file",errorTypeFileNotSupport:"This type file not support",btnNameClose:"Close",btnNameAddFile:"Add file",btnNameDelete:"Delete",title:"Create PDF file",btnNameCreate:"Create PDF",textFileSize:"File size",textFileName:"File name",textDrop:"Drag a file here",textOr:"or"},locales:{}},o=function(a,b){var c=b.className;c.indexOf(a)==-1&&(""!=c&&(a=" "+a),b.className=c+a)},p=function(a){var b,c=+new Date,d=document.createElement("div");return b=function(){for(var e=v({id:c,storageId:a.storageId,locales:a.locales}),f=e.getElementsByClassName("btn-delete"),g=0;g<f.length;g++)f[g].onclick=function(c){var e=[],f=c.target.dataset.id;m[a.storageId].forEach(function(a,b){f!=b&&e.push(a)}),m[a.storageId]=e,d.children.length&&d.children[0].remove(),m[a.storageId].forEach(function(b){b.isSupport=s(b.typeName,a.storageId)}),t(a.storageId),d.appendChild(b())};return e},d.appendChild(b()),d},q=function(a){var b=+new Date,c=w({id:b,locales:a.locales}),d=this,e=c.getElementsByClassName("drop-zone")[0],f=c.getElementsByClassName("file-load")[0],g=c.getElementsByClassName("text-error")[0];return f.addEventListener("change",function(b){g.innerText="",d.addFile(b.target.files[0],{success:a.success,error:function(a){g.innerText=a}})}),e.ondragover=function(){return g.innerText="",o("hover",e),!1},e.ondragleave=function(){return g.innerText="",u("hover",e),!1},e.ondrop=function(b){b.preventDefault(),g.innerText="",u("hover",e),o("drop",e);var c=b.dataTransfer.files[0];d.addFile(c,{success:a.success,error:function(a){g.innerText=a}})},c},r=function(a){var b;if(b=n.locales[a]?n.locales[a]:n.localesDefault,this._locales)for(var c in this._locales)b[c]=this._locales[c];return b},s=function(a,b,c){return i.indexOf(a.toUpperCase())>-1||(j.indexOf(a.toUpperCase())>-1||(k.indexOf(a.toUpperCase())>-1||"PDF"==a.toUpperCase()&&m[b].length==c))},t=function(a){m[a].forEach(function(b){b.isSupport=s(b.typeName,a,1)})};ParseHtml=function(a,b){var c=document.createElement("div");c.innerHTML=a,b=b||[];for(var d=0;d<c.children.length;d++)["div","p","table"].indexOf(c.children[d].nodeName.toLowerCase())<0?b.push(e(b,c.children[d],f(),[])):e(b,c.children[d],f(),[]);return b};var u=function(a,b){var c=b.className,d=new RegExp("\\s?\\b"+a+"\\b","g");c=c.replace(d,""),b.className=c},v=function(a){var b=document.createElement("div");return m[a.storageId].forEach(function(c,d){var e,f=document.createElement("div"),g="";f.className="",c.isSupport===!1&&(f.className=" error-support",g='<div class="text-error">'+a.locales.errorTypeFileNotSupport+"</div>"),e="image"==c.typeName?'<img src="'+c.content+'" alt="" class="img-rounded">':'<div class="img-rounded">'+c.typeName+"</div>",f.className+=" wrapper-img",f.innerHTML=e+'<div class="block-info"><div><div class="label-file">'+a.locales.textFileName+'</div><div class="info-file">'+c.name+'</div></div><div><div class="label-file">'+a.locales.textFileSize+'</div><div class="info-file">'+c.sizeName+"</div></div>"+g+'<div><button type="button" class="btn btn-default btn-delete " data-id="'+d+'" >'+a.locales.btnNameDelete+"</button></div></div>",b.appendChild(f)}),b},w=function(a){var b=document.createElement("div");return b.innerHTML='<div class="drop-zone"><div>'+a.locales.textDrop+"</div><div>"+a.locales.textOr+'</div><div class="text-error"></div><div class="fm-drop-zone-message"><div><input class="file-load" type="file"></div></div></div></div>',b},x=function(a){var b=document.createElement("div");return b.className="wrapper-pdf-waite",b.innerHTML='<div class="floatingCirclesG"><div class="f_circleG frotateG_01"></div><div class="f_circleG frotateG_02"></div><div class="f_circleG frotateG_03"></div><div class="f_circleG frotateG_04"></div><div class="f_circleG frotateG_05"></div><div class="f_circleG frotateG_06"></div><div class="f_circleG frotateG_07"></div><div class="f_circleG frotateG_08"></div></div>',b},y=function(a){var b=document.createElement("div"),c=window.innerHeight;return b.innerHTML='<div class="wrapper-pdf-create"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header">'+a.locales.title+'</div><div class="modal-body" style="max-height: '+c+'px" ></div><div class="modal-footer"><button type="button" class="btn btn-default btn-close " data-dismiss="modal">'+a.locales.btnNameClose+'</button><button type="button" class="btn btn-primary btn-add">'+a.locales.btnNameAddFile+'</button><span class="error-footer text-error"></span><button type="button" class="btn btn-success btn-save">'+a.locales.btnNameCreate+"</button></div></div></div></div>",b};g.prototype.addFile=function(a,c){var d,e=new FileReader,f=this,g=r.call(this,this._locale),h=a.name.split(".").pop();if(a.type.indexOf("image")>-1||i.indexOf(h.toUpperCase())>-1)d="image";else if(a.type.indexOf("html")>-1||k.indexOf(h.toUpperCase())>-1)d="html";else if(a.type.indexOf("text")>-1||j.indexOf(h.toUpperCase())>-1)d="text";else if(a.type.indexOf("pdf")>-1)d="pdf";else{if(!(a.type.indexOf("zip")>-1))return c.error(g.errorTypeFileNotSupport),!1;d="zip",b().loadAsync(a).then(function(a){for(var b in a.files)!function(a){!function(a,b){var d="base64",e="";i.indexOf(a.toUpperCase())>-1?(e="data:image/"+a.toLowerCase()+";base64,",a="image",d="base64"):j.indexOf(a.toUpperCase())>-1?(a="text",d="string"):k.indexOf(a.toUpperCase())>-1&&(a="html",d="string"),b.async(d).then(function(d){m[f._storageId].push({lastModified:+b.date,name:b.name,size:0,sizeName:"ZIP",type:a,typeName:a,content:e+d}),t(f._storageId),c.success()})}(a.name.split(".").pop(),a)}(a.files[b])})}"zip"!=d&&(e.onload=function(b){var e=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]};m[f._storageId].push({lastModified:a.lastModified,name:a.name,size:a.size,sizeName:e(a.size),type:a.type,typeName:d,content:b.target.result}),t(f._storageId),c.success()},j.indexOf(d.toUpperCase())>-1||k.indexOf(d.toUpperCase())>-1?e.readAsText(a,"UTF-8"):e.readAsDataURL(a))};var z={};return g.prototype.on=function(a,b){void 0===z[a]&&(z[a]={callback:[],callbackOnce:[]}),z[a].callback.push(b)},g.prototype.once=function(a,b){void 0===z[a]&&(z[a]={callback:[],callbackOnce:[]}),z[a].callbackOnce.push(b)},g.prototype.off=function(a,b){var c;if("function"==typeof b){if(z[a].callback&&z[a].callback.length>0){c=[];for(var d=0;d<z[a].callback.length;d++)"function"==typeof z[a].callback[d]&&z[a].callback[d]!==b&&c.push(z[a].callback[d]);z[a].callback=c}if(z[a].callbackOnce&&z[a].callbackOnce.length>0){c=[];for(var d=0;d<z[a].callbackOnce.length;d++)"function"==typeof z[a].callbackOnce[d]&&z[a].callbackOnce[d]!==b&&c.push(z[a].callbackOnce[d]);z[a].callbackOnce=c}}else delete z[a]},g.prototype.trigger=function(a){if(z[a]){var b=[];for(var c in arguments)0!=c&&b.push(arguments[c]);if(z[a].callback&&z[a].callback.length>0)for(var d=0;d<z[a].callback.length;d++)"function"==typeof z[a].callback[d]&&z[a].callback[d].apply(this,b);if(z[a].callbackOnce&&z[a].callbackOnce.length>0){for(var d=0;d<z[a].callbackOnce.length;d++)"function"==typeof z[a].callbackOnce[d]&&z[a].callbackOnce[d].apply(this,b);z[a].callbackOnce=[]}}},g.prototype.isValid=function(){var a=!0;return m[this._storageId].forEach(function(b){b.isSupport===!1&&(a=!1)}),a},g.prototype.openModal=function(a,b){if(a=a||this._typeOpen,h.indexOf(a)<0)throw"Not fount typeOpen ["+a+"]";if(l.indexOf(a)>-1&&"function"!=typeof b)throw"Set function callback in param callback";this._wrapper.appendChild(this.view(a,b))},g.prototype.view=function(a,b){var c=+new Date,d=this,e=r.call(this,this._locale),f=y({id:c,locales:e,btnNameClose:n.btnNameClose,btnNameAddFile:n.btnNameAddFile,btnNameCreate:n.btnNameCreate,title:n.title}),g=f.getElementsByClassName("modal-body")[0],h=f.getElementsByClassName("btn-close")[0],i=f.getElementsByClassName("btn-add")[0],j=f.getElementsByClassName("error-footer")[0],k=f.getElementsByClassName("btn-save")[0];return h.onclick=function(a){f.remove(),d.trigger("close")},k.onclick=function(c){if(j.innerText="",d.isValid()===!1)return j.innerText=e.errorArrayLoadFile,!1;if(1==m[d._storageId].length&&"PDF"==m[d._storageId][0].typeName.toUpperCase()){switch(a){case"getBase64":b(m[d._storageId][0].content.substring(m[d._storageId][0].content.indexOf("base64,")+7)),f.remove(),d.trigger("close");break;case"getDataUrl":b(m[d._storageId][0].content),f.remove(),d.trigger("close");break;default:j.innerText="Work only function callback getBase64 getDataUrl"}return!1}var g={content:[]};switch(m[d._storageId].forEach(function(a,b){"image"==a.typeName&&g.content.push({image:a.content,fit:[525,700]}),"html"==a.typeName&&ParseHtml(a.content,g.content),"text"==a.typeName&&g.content.push({text:a.content,fontSize:8})}),a){case"download":pdfMake.createPdf(g).download(d._documentName+".pdf");break;case"open":pdfMake.createPdf(g).open();break;case"print":pdfMake.createPdf(g).print();break;case"getBase64":d.waitStart(),pdfMake.createPdf(g).getBase64(function(a){b(a),d.waitStop()});break;case"getBlob":d.waitStart(),pdfMake.createPdf(g).getBlob(function(a){b(a),d.waitStop()});break;case"getDataUrl":d.waitStart(),pdfMake.createPdf(g).getDataUrl(function(a){b(a),d.waitStop()})}f.remove(),d.trigger("close")},i.onclick=function(a){i.style.display="none",k.style.display="none",d.trigger("add:file"),g.appendChild(q.call(d,{locales:e,success:function(){i.style.display="block",k.style.display="block",g.innerHTML="",g.appendChild(p({storageId:d._storageId,locales:e}))}})),g.scrollTop=g.scrollHeight},m[d._storageId].length?g.appendChild(p({storageId:d._storageId,locales:e})):(i.style.display="none",k.style.display="none",g.appendChild(q.call(d,{locales:e,success:function(){i.style.display="block",k.style.display="block",g.innerHTML="",g.appendChild(p({storageId:d._storageId,locales:e}))}}))),f},g.prototype.waitStart=function(){this._templateWait&&this._templateWait.remove(),this._templateWait=x({}),this._wrapper.appendChild(this._templateWait)},g.prototype.waitStop=function(a,b){this._templateWait&&this._templateWait.remove()},g});